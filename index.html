<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Desktop Prototype</title>
  <link rel="stylesheet" href="./css/style.css" />
</head>
<body>
  <!-- TITLE SCREEN OVERLAY -->
  <div id="title-screen">
    <img src="./assets/ui/title_screen.png" id="title-img" alt="Title Screen">
    <button id="title-play-btn">Play Game</button>
    <button id="btn-explanation" class="title-btn">Explanation</button>
  </div>

  <!-- EXPLANATION SCREEN -->
  <div id="explanation-screen" class="hidden">
    <img
      id="explanation-bg"
      src="./assets/ui/explanation_page.png"
      alt="Explanation Page"
    />
  </div>

  <!-- MAIN GAME FRAME -->
  <div class="frame">
    <!-- Monitor background image -->
    <img class="monitor" src="./assets/ui/computer_base.png" alt="computer base" />

    <div class="screen" id="screen">
      <!-- Dock icons -->
      <div class="dock">
        <button class="icon" data-open="#win-design">
          <img src="./assets/ui/design_app_icon.png" alt="Design App">
          <span class="icon-label">Design</span>
        </button>

        <button class="icon" data-open="#win-web">
          <img src="./assets/ui/web_app_icon.png" alt="Web App">
          <span class="icon-label">Web Search</span>
        </button>

        <button class="icon" data-open="#win-email">
          <img src="./assets/ui/email_app_icon.png" alt="Email App">
          <span class="icon-label">Zoomi Mail</span>
        </button>

        <button class="icon" data-open="#win-briefs">
          <img src="./assets/ui/question_block.png" alt="question block">
          <span class="icon-label">Explanation</span>
        </button>

        <button class="icon" data-open="#win-notes">
          <img src="./assets/ui/note_pad.png" alt="note_pad">
          <span class="icon-label">Notes</span>
        </button>

        <button class="icon" data-open="#win-commissions">
          <img src="./assets/ui/commissions_app.png" alt="commissions">
          <span class="icon-label">Commissions</span>
        </button>

        <button class="icon" data-open="#win-cash">
          <img src="./assets/ui/cash_app.png" alt="cash">
          <span class="icon-label">Cash</span>
        </button>

      </div>

      <!-- Email -->
      <div class="win hidden" id="win-email">
        <div class="titlebar">
          <div class="btn btn-close" data-close></div>
          <div class="btn btn-min" data-min></div>
          <div class="btn btn-max" data-max></div>
          <div class="title">Email</div>
        </div>
        <div class="content">
          <div id="email-app">
            <aside>
              <div class="email-header">
                <h1 class="email-inbox-title">Inbox</h1>
              </div>
              <div id="m-list"></div>
            </aside>

            <main>
              <!-- header hidden with CSS but kept for structure -->
              <div class="email-main-header">
                <div id="m-subj">(no message selected)</div>
              </div>

              <div class="email-main-body">
                <div id="m-meta"></div>
                <div id="m-body" style="white-space:pre-wrap;"></div>
                <div id="m-actions"></div>
              </div>
            </main>
          </div>
        </div>
      </div>

      <!-- Design window -->
      <div class="win hidden" id="win-design">
        <div class="titlebar">
          <div class="btn btn-close" data-close></div>
          <div class="btn btn-min" data-min></div>
          <div class="btn btn-max" data-max></div>
          <div class="title"> Terracotta Design</div>
        </div>
        <div class="content">
          <div class="design-shell">
            <!-- LEFT TOOL BAR -->
            <aside class="tool-panel">
              <button id="pen" class="tool-btn active">
                <img src="./assets/ui/pen_tool.png" alt="Pen tool" class="tool-icon">
              </button>
            
              <button id="bucket" class="tool-btn">
                <img src="./assets/ui/paint_bucket_tool.png" alt="Paint Bucket tool" class="tool-icon">
              </button>
            
              <button id="type" class="tool-btn">
                <img src="./assets/ui/type_tool.png" alt="Text tool" class="tool-icon">
              </button>
            
              <button id="eraser" class="tool-btn">
                <img src="./assets/ui/eraser_tool.png" alt="Erase tool" class="tool-icon">
              </button>
            
              <button id="shape" class="tool-btn">
                <img src="./assets/ui/shape_tool.png" alt="Shape tool" class="tool-icon">
              </button>
            
              <button id="open-assets" class="tool-btn">
                <img src="./assets/ui/asset_tool.png" alt="Asset tool" class="tool-icon">
              </button>
            
              <button id="line" class="tool-btn">
                <img src="./assets/ui/line_tool.png" alt="Line tool" class="tool-icon">
              </button>
            
              <button id="move" class="tool-btn">
                <img src="./assets/ui/move_tool.png" alt="Move tool" class="tool-icon">
              </button>
            
              <button id="undo" class="tool-btn">
                <img src="./assets/ui/undo_tool.png" alt="Undo tool" class="tool-icon">
              </button>
            
              <button id="picker" class="tool-btn">
                <img src="./assets/ui/eyedropper_tool.png" alt="Eye dropper tool" class="tool-icon">
              </button>
            
              <button id="clear" class="tool-btn">
                <img src="./assets/ui/trash_tool.png" alt="Trash tool" class="tool-icon">
              </button>
            
              <button id="upload" class="tool-btn">
                <img src="./assets/ui/upload_tool.png" alt="Upload tool" class="tool-icon">
              </button>
            
              <!-- keep hidden for save shortcut -->
              <button id="savepng" style="display:none;">Save PNG</button>
            </aside>
            
            <script>
              document.addEventListener("DOMContentLoaded", () => {
                const icons = document.querySelectorAll(".dock .icon");
              
                icons.forEach(icon => {
                  icon.addEventListener("click", () => {
                    icon.classList.remove("icon-click-anim"); // reset animation
                    void icon.offsetWidth;                   // force reflow
                    icon.classList.add("icon-click-anim");   // trigger animation
                  });
                });
              });
              </script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // DESIGN TOOL BUTTONS
    const toolButtons = document.querySelectorAll(".tool-btn");
  
    toolButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        btn.classList.remove("icon-click-anim"); // reset animation
        void btn.offsetWidth;                    // force reflow
        btn.classList.add("icon-click-anim");    // trigger animation
      });
    });
  });
  </script>
                

            <!-- CENTER: SIZE SLIDER + CANVAS -->
            <main class="design-center">
              <div class="size-bar">
                <span class="size-label">Size</span>
                <input id="size" type="range" min="1" max="70" value="32">
              </div>

              <div class="canvas-frame">
                <canvas id="canvas" width="1280" height="720"></canvas>
              </div>
            </main>

            <!-- RIGHT: TYPEFACE + COLOR PANELS -->
            <aside class="right-panel">
              <section class="panel typeface-panel">
                <div class="panel-header">Typeface</div>
                <div class="typeface-body">
                  <button id="font-prev" class="font-scroll">‚ñ≤</button>
                  <span id="font-name" class="font-label">Arial</span>
                  <button id="font-next" class="font-scroll">‚ñº</button>
                </div>
              </section>

              <section class="panel color-panel">
                <div class="panel-header">Color</div>
                <div class="color-body">
                  <div class="swatch-grid">
                    <!-- top row -->
                    <button class="swatch" data-color="#e53935"></button>
                    <button class="swatch" data-color="#fb8c00"></button>
                    <button class="swatch" data-color="#fdd835"></button>
                    <button class="swatch" data-color="#43a047"></button>
                    <!-- row 2 -->
                    <button class="swatch" data-color="#1e88e5"></button>
                    <button class="swatch" data-color="#039be5"></button>
                    <button class="swatch" data-color="#8e24aa"></button>
                    <button class="swatch" data-color="#6d4c41"></button>
                    <!-- row 3 -->
                    <button class="swatch" data-color="#8d6e63"></button>
                    <button class="swatch" data-color="#b0bec5"></button>
                    <button class="swatch" data-color="#ffffff"></button>
                    <button class="swatch" data-color="#000000"></button>
                  </div>
                  <!-- hidden native color input so existing JS still works -->
                  <input type="color" id="color" value="#000000" style="display:none;">
                </div>
              </section>
            </aside>
          </div>
        </div>
      </div>

      <!-- Web window -->
<div class="win hidden" id="win-web">
  <div class="titlebar">
    <div class="btn btn-close" data-close></div>
    <div class="btn btn-min" data-min></div>
    <div class="btn btn-max" data-max></div>
    <div class="title">Web</div>
  </div>

  <div class="content web-shell">
    <!-- Fake browser tab bar -->
    <div class="web-tabbar">
      <button id="web-back" class="web-back hidden">‚óÄ Back</button>
      <div class="web-tab active" id="web-tab-title">New tab</div>
    </div>

    <!-- ‚ÄúBrowser‚Äù viewport -->
    <div class="web-view">
      <!-- HOME PAGE -->
      <section id="web-home" class="web-page">
        <div class="web-logo-row">
          <div class="web-logo-circle">üåê</div>
        </div>

        <div class="web-search-row">
          <div class="web-search-box">
            <input
              id="web-search-input"
              type="text"
              placeholder="Search"
              autocomplete="off"
            />
            <button id="web-search-btn" class="web-search-icon">üîç</button>
          </div>
        </div>

        <div class="web-suggest-title">Suggested Search</div>

        <div class="web-suggest-row">
          <button class="web-suggest" data-web-search="client">
            client research
          </button>
          <button class="web-suggest" data-web-search="principles">
            principles of design
          </button>
          <button class="web-suggest" data-web-search="color">
            color theory
          </button>
        </div>
      </section>

      <!-- PRINCIPLES PAGE -->
      <section id="web-principles" class="web-page hidden">
        <div class="web-img-wrap">
          <img
            src="./assets/ui/principles_of_design.png"
            alt="Principles of design"
            class="web-img-full"
          />
        </div>
      </section>

      <!-- COLOR THEORY PAGE -->
      <section id="web-color" class="web-page hidden">
        <div class="web-img-wrap">
          <img
            src="./assets/ui/color_theory_page.png"
            alt="Color Theory"
            class="web-img-full"
          />
        </div>
      </section>
      <!-- CLIENTPEDIA PAGE -->
      <section id="web-client" class="web-page hidden">
        <div class="web-client-inner">
          <div class="web-img-wrap">
            <img
              id="client-img"
              src="./assets/ui/April_Greiman_Bio.png"
              alt="Clientpedia ‚Äì April Greiman"
              class="web-img-full"
            />
          </div>

          <!-- bottom-right pager button -->
          <button id="client-next" class="client-next-btn">
            Next client ‚ñ∂
          </button>
        </div>
      </section>
        <div class="web-client-controls">
          <button id="web-client-prev" type="button">‚óÄ Previous</button>
          <span id="web-client-label">April Greiman</span>
          <button id="web-client-next" type="button">Next ‚ñ∂</button>
        </div>
      </section>
    </div>
  </div>
</div>


      <!-- Briefs -->
      <div class="win hidden" id="win-briefs">
        <div class="titlebar">
          <div class="btn btn-close" data-close></div>
          <div class="btn btn-min" data-min></div>
          <div class="btn btn-max"></div>
          <div class="title">Briefs</div>
        </div>
        <div class="content">
          <div id="briefs-list" class="briefs-list"></div>
        </div>
      </div>

      <!-- Notes -->
      <div class="win hidden" id="win-notes">
        <div class="titlebar">
          <div class="btn btn-close" data-close></div>
          <div class="btn btn-min" data-min></div>
          <div class="btn btn-max" data-max></div>
          <div class="title">Notes</div>
        </div>
        <div class="content">
          <textarea placeholder="Write notes..."></textarea>
        </div>
      </div>

      <!-- Asset Browser window -->
      <div class="win hidden" id="win-asset-browser">
        <div class="titlebar">
          <div class="btn btn-close" data-close></div>
          <div class="btn btn-min" data-min></div>
          <div class="btn btn-max" data-max></div>
          <div class="title">Assets</div>
        </div>
        <div class="content">
          <div id="asset-toolbar" class="asset-toolbar">
            <input id="asset-filter" type="search" placeholder="Filter assets..." />
          </div>
          <div id="asset-grid" class="asset-grid"></div>
          <div class="muted" style="margin-top:8px;">Tip: click an asset to place it in the canvas.</div>
        </div>
      </div>

      <!-- Commissions -->
<div class="win hidden" id="win-commissions">
  <div class="titlebar">
    <div class="btn btn-close" data-close></div>
    <div class="btn btn-min" data-min></div>
    <div class="btn btn-max" data-max></div>
    <div class="title">Commissions</div>
  </div>
  <div class="content">
    <div id="commissions-app" class="comm-shell">
      <!-- LEFT: list of commissions -->
      <aside class="comm-list-pane">
        <h1 class="comm-title">Paid Commissions</h1>
        <div id="comm-list" class="comm-list">
          <!-- JS will inject up to 10 briefs here -->
        </div>
      </aside>

      <!-- RIGHT: detail view -->
      <main class="comm-detail-pane">
        <div class="comm-detail-card">
          <div id="comm-detail-main" class="comm-detail-main">
            <p class="comm-empty">
              Select a commission on the left to view the full brief.
            </p>
          </div>

          <div class="comm-detail-actions">
            <button id="comm-accept" class="comm-btn comm-btn-accept" disabled>
              Accept
            </button>
            <button id="comm-decline" class="comm-btn comm-btn-decline" disabled>
              Decline
            </button>
          </div>
        </div>
      </main>
    </div>
  </div>
</div>

<!-- Cash Tracker -->
<div class="win hidden" id="win-cash">
  <div class="titlebar">
    <div class="btn btn-close" data-close></div>
    <div class="btn btn-min" data-min></div>
    <div class="btn btn-max" data-max></div>
    <div class="title">Cash Tracker</div>
  </div>

  <div class="content">
    <div id="cash-app" class="cash-shell">
      <header class="cash-header">Cash Tracker</header>

      <div class="cash-main">
        <!-- LEFT: balance + transactions -->
        <section class="cash-panel cash-panel-left">
          <h2 class="cash-subtitle">Transactions</h2>

          <div class="cash-balance-row">
            <span class="cash-balance-label">Total:</span>
            <span id="cash-balance" class="cash-balance-amount">$0.00</span>
          </div>

          <div id="cash-history" class="cash-history">
            <!-- JS will render transactions here -->
          </div>
        </section>

        <!-- RIGHT: rent panel -->
        <section class="cash-panel cash-panel-right">
          <h2 class="cash-subtitle">Pay Rent</h2>

          <p class="cash-rent-copy">
            Keep up with your bills by paying rent from your project income.
          </p>

          <div class="cash-rent-row">
            <span class="cash-rent-label">Rent amount:</span>
            <span id="cash-rent-amount" class="cash-rent-amount">$300.00</span>
          </div>

          <button id="cash-pay-rent" class="cash-pay-btn">Pay Rent</button>

          <p id="cash-rent-status" class="cash-rent-status">
            Status: Rent not paid this cycle.
          </p>
        </section>
      </div>
    </div>
  </div>
</div>


    </div><!-- end .screen -->
  </div><!-- end .frame -->

  <!-- Dialogue overlay -->
  <div id="dialogue-layer" class="dialogue hidden">
    <div class="dialogue-inner">
      <img
        src="./assets/ui/dialouge_box.png"
        alt="Dialogue box"
        class="dialogue-frame"
      />

      <div class="dialogue-face-wrap">
        <img
          id="dialogue-face"
          src="./assets/ui/IMG_0256.png"
          alt="Griffin portrait"
          class="dialogue-face"
        />
      </div>

      <div class="dialogue-text-wrap">
        <div id="dialogue-name" class="dialogue-name">Griffin Flowers</div>
        <div id="dialogue-text" class="dialogue-text"></div>
        <div class="dialogue-hint">click to continue</div>
      </div>
    </div>
  </div>

  <!-- core scripts -->
  <script src="./js/app.js"></script>
  <script src="./js/assets_browser.js"></script>
  <script src="./js/briefs.js"></script>
  <script src="./js/state.js"></script>
  <script src="./js/commissions.js"></script>
  <script src="./js/email.js"></script>
  <script src="./js/cash.js"></script>


  <!-- DESIGN ENGINE (drawing + text + stickers + FREE TRANSFORM) -->
  <script>
  (function(){
    // --- Grab & reset canvas so old listeners are detached ---
    const oldCanvas = document.getElementById('canvas');
    if (!oldCanvas) return;

    const canvas = oldCanvas.cloneNode(true);
    oldCanvas.parentNode.replaceChild(canvas, oldCanvas);

    const ctx = canvas.getContext('2d');
    const W = canvas.width;
    const H = canvas.height;

    // Offscreen paint layer for brush strokes
    const paint = document.createElement('canvas');
    paint.width = W;
    paint.height = H;
    const pctx = paint.getContext('2d');
    pctx.fillStyle = '#111722';   // background
    pctx.fillRect(0, 0, W, H);

    // UI elements
    const colorInput = document.getElementById('color');
    const sizeInput  = document.getElementById('size');
    const fontLabel  = document.getElementById('font-name');
    const fontPrev   = document.getElementById('font-prev');
    const fontNext   = document.getElementById('font-next');
    const typeBtn    = document.getElementById('type');

    if (!window.__designHot) window.__designHot = {};
    const hot = window.__designHot;

    const FONTS = ['Arial', 'Georgia', 'Impact', 'Verdana', 'Courier New', 'Trebuchet MS', 'Times New Roman'];
    let fontIndex = 0;

    function updateFontLabel(){
      if (fontLabel) fontLabel.textContent = FONTS[fontIndex];
    }
    updateFontLabel();

    fontPrev?.addEventListener('click', ()=>{
      fontIndex = (fontIndex - 1 + FONTS.length) % FONTS.length;
      updateFontLabel();
    });
    fontNext?.addEventListener('click', ()=>{
      fontIndex = (fontIndex + 1) % FONTS.length;
      updateFontLabel();
    });

    // Save drawing state on the hot object
    hot.view  = ctx;
    hot.paint = paint;
    hot.pctx  = pctx;

    hot.tool         = hot.tool || 'pen';
    hot.stickers     = hot.stickers || [];
    hot.textItems    = hot.textItems || [];
    hot.typing       = hot.typing || null;
    hot.linePreview  = hot.linePreview || null;   // line drag preview
    hot.shapePreview = hot.shapePreview || null;  // shape drag preview
    hot.shapeMode    = hot.shapeMode || 'rect';   // 'rect' or 'circle'

    function drawTextItem(ctx, t, isPreview=false){
      ctx.save();
      ctx.fillStyle = t.color;
      ctx.textBaseline = 'top';
      ctx.font = `${t.size}px "${t.font}"`;
      ctx.fillText(t.text, t.x, t.y);
      if (!isPreview) {
        const m = ctx.measureText(t.text);
        t.w = m.width;
        t.h = t.size * 1.2;
      }
      if (t.selected && !isPreview){
        ctx.strokeStyle = '#7bdcff';
        ctx.setLineDash([6,4]);
        ctx.lineWidth   = 1.5;
        ctx.strokeRect(t.x-4, t.y-2, (t.w||0)+8, (t.h||t.size*1.2)+4);
      }
      ctx.restore();
    }

    hot.clearPaint = function(){
      pctx.fillStyle = '#faf8e8';
      pctx.fillRect(0, 0, paint.width, paint.height);
    };

    let drawing = false;
    let last    = null;

    canvas.addEventListener('mousedown', (e)=>{
      const {x,y} = canvasXY(e);
      const active = hot.tool;

      if (active==='move'){
        const t = hitText(x,y);
        const s = t ? null : hitSticker(x,y);
        hot.textItems.forEach(a=>a.selected=false);
        hot.stickers.forEach(a=>a.selected=false);
        if (t){
          t.selected = true;
          hot.dragTarget = t;
          hot.dragOff    = {x: x - t.x, y: y - t.y};
        } else if (s){
          s.selected = true;
          const {cx,cy} = stickerCenter(s);
          hot.dragTarget = s;
          hot.dragOff    = {x: x - cx, y: y - cy};
        } else {
          hot.dragTarget = null;
        }
        return;
      }

      if (active==='type'){
        hot.typing = {x, y, text: ''};
        return;
      }

      if (active==='bucket'){
        floodFill(x,y, hexToRgba(colorInput?.value || '#ffffff'));
        return;
      }
      if (active==='picker'){
        const c = hot.view.getImageData(x,y,1,1).data;
        if(colorInput) {
          colorInput.value = `#${[c[0],c[1],c[2]].map(v=>v.toString(16).padStart(2,'0')).join('')}`;
        }
        return;
      }
      if (active === 'shape') {
        hot.shapePreview = { x1:x, y1:y, x2:x, y2:y };
        return;
      }
      if (active === 'line') {
        hot.linePreview = { x1:x, y1:y, x2:x, y2:y };
        return;
      }

      drawing = true;
      last    = {x,y};
      drawDot(x,y, curColor(), curSize());
    });

    window.addEventListener('mouseup', ()=>{
      drawing = false;
      hot.dragTarget = null;

      // Commit line to paint
      if (hot.linePreview) {
        const lp = hot.linePreview;
        drawLine(lp.x1, lp.y1, lp.x2, lp.y2, curColor(), curSize());
        hot.linePreview = null;
      }

      // Commit shape to paint
      if (hot.shapePreview) {
        const sp = hot.shapePreview;
        let x1 = sp.x1, y1 = sp.y1, x2 = sp.x2, y2 = sp.y2;
        let left = Math.min(x1, x2);
        let top  = Math.min(y1, y2);
        let w    = Math.abs(x2 - x1);
        let h    = Math.abs(y2 - y1);

        if (w > 0 && h > 0) {
          const ctx = hot.pctx;
          ctx.save();
          ctx.fillStyle = curColor();
          ctx.beginPath();
          if (hot.shapeMode === 'circle') {
            const cx = left + w / 2;
            const cy = top  + h / 2;
            const rx = w / 2;
            const ry = h / 2;
            ctx.ellipse(cx, cy, rx, ry, 0, 0, Math.PI * 2);
          } else {
            ctx.rect(left, top, w, h);
          }
          ctx.fill();
          ctx.restore();
        }

        hot.shapePreview = null;
      }
    });

    canvas.addEventListener('mousemove', (e)=>{
      const {x,y}=canvasXY(e);
      if (hot.dragTarget){
        const t = hot.dragTarget;
        if ('text' in t){
          t.x = x - hot.dragOff.x;
          t.y = y - hot.dragOff.y;
          return;
        } else {
          t.x = x - hot.dragOff.x;
          t.y = y - hot.dragOff.y;
          return;
        }
      }

      // SHAPE preview
      if (hot.tool === 'shape' && hot.shapePreview) {
        const sp = hot.shapePreview;
        const x1 = sp.x1;
        const y1 = sp.y1;
        let x2 = x;
        let y2 = y;

        if (e.shiftKey) {
          const dx = x2 - x1;
          const dy = y2 - y1;
          const size = Math.max(Math.abs(dx), Math.abs(dy)) || 1;
          const signX = dx >= 0 ? 1 : -1;
          const signY = dy >= 0 ? 1 : -1;
          x2 = x1 + signX * size;
          y2 = y1 + signY * size;
        }

        sp.x2 = x2;
        sp.y2 = y2;
        return;
      }

      // LINE preview
      if (hot.tool === 'line' && hot.linePreview) {
        hot.linePreview.x2 = x;
        hot.linePreview.y2 = y;
        return;
      }

      if(!drawing) return;

      drawLine(last.x,last.y,x,y, curColor(), curSize());
      last = {x,y};
    });

    window.addEventListener('keydown', (e)=>{
      if (!hot.typing) {
        if (e.key.toLowerCase()==='t'){ setTool('type'); }
        return;
      }
      if (e.key==='Enter'){
  const item = {
    x: hot.typing.x, y: hot.typing.y, text: hot.typing.text,
    font: FONTS[fontIndex], size: Number(sizeInput?.value || 16),
    color: colorInput?.value || '#ffffff',
    selected:false, w:0, h:0
  };
  hot.textItems.push(item);

  // --- track fonts we used this attempt ---
  if (!hot.usedFontsArr) hot.usedFontsArr = [];
  if (!hot.usedFontsArr.includes(item.font)) {
    hot.usedFontsArr.push(item.font);
  }

  hot.typing = null;
  return;
}

      if (e.key==='Escape'){
        hot.typing = null;
        return;
      }
      if (e.key==='Backspace'){
        e.preventDefault();
        hot.typing.text = (hot.typing.text||'').slice(0,-1);
        return;
      }
      if (e.key.length===1){
        hot.typing.text = (hot.typing.text||'') + e.key;
      }
    });

    function canvasXY(e){
      const r = canvas.getBoundingClientRect();
      return {
        x: Math.floor((e.clientX - r.left) * (canvas.width  / r.width)),
        y: Math.floor((e.clientY - r.top)  * (canvas.height / r.height))
      };
    }
    function curColor(){
      return (hot.tool==='eraser') ? '#faf8e8' : (colorInput?.value || '#000000');
    }
    function curSize(){
      return Number(sizeInput?.value || 3);
    }
    function drawDot(x,y,color,size){
      hot.pctx.fillStyle = color;
      hot.pctx.beginPath();
      hot.pctx.arc(x,y,size,0,Math.PI*2);
      hot.pctx.fill();
    }
    function drawLine(x1,y1,x2,y2,color,size){
      hot.pctx.strokeStyle = color;
      hot.pctx.lineWidth   = size*2;
      hot.pctx.lineCap     = 'round';
      hot.pctx.beginPath();
      hot.pctx.moveTo(x1,y1);
      hot.pctx.lineTo(x2,y2);
      hot.pctx.stroke();
    }
    function hexToRgba(hex){
      hex = hex.replace('#','');
      if(hex.length===3) hex = hex.split('').map(c=>c+c).join('');
      return [
        parseInt(hex.slice(0,2),16),
        parseInt(hex.slice(2,4),16),
        parseInt(hex.slice(4,6),16),
        255
      ];
    }
    function floodFill(x,y,newCol){
      const img = hot.pctx.getImageData(0,0,hot.paint.width,hot.paint.height);
      const d=img.data, w=hot.paint.width, h=hot.paint.height;
      const idx=(x,y)=>(y*w+x)*4;
      const s=idx(x,y);
      const tgt=[d[s],d[s+1],d[s+2]];
      if(tgt[0]===newCol[0]&&tgt[1]===newCol[1]&&tgt[2]===newCol[2]) return;
      const stack=[[x,y]];
      while(stack.length){
        const [cx,cy]=stack.pop();
        if(cx<0||cy<0||cx>=w||cy>=h) continue;
        const i=idx(cx,cy);
        if(d[i]===tgt[0]&&d[i+1]===tgt[1]&&d[i+2]===tgt[2]){
          d[i]=newCol[0]; d[i+1]=newCol[1]; d[i+2]=newCol[2]; d[i+3]=255;
          stack.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]);
        }
      }
      hot.pctx.putImageData(img,0,0);
    }
    function hitSticker(x,y){
      for(let i=hot.stickers.length-1;i>=0;i--){
        const s=hot.stickers[i];
        const cw=s.w*s.scale, ch=s.h*s.scale;
        const left=s.x - cw/2, top=s.y - ch/2;
        if (x>=left && x<=left+cw && y>=top && y<=top+ch) return s;
      }
      return null;
    }
    function stickerCenter(s){
      return {cx:s.x, cy:s.y};
    }
    function hitText(x,y){
      for(let i=hot.textItems.length-1;i>=0;i--){
        const t=hot.textItems[i];
        const w=t.w||0, h=t.h||t.size*1.2;
        if (x>=t.x-2 && x<=t.x+w+2 && y>=t.y-2 && y<=t.y+h+2) return t;
      }
      return null;
    }

    function render() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (hot.paint) {
        ctx.drawImage(hot.paint, 0, 0);
      }

      for (const s of hot.stickers) {
        const cw = s.w * s.scale, ch = s.h * s.scale;
        const x = s.x - cw / 2,   y = s.y - ch / 2;
        ctx.drawImage(s.img, x, y, cw, ch);
        if (s.selected) {
          ctx.save();
          ctx.strokeStyle = '#7bdcff';
          ctx.setLineDash([6, 4]);
          ctx.lineWidth = 2;
          ctx.strokeRect(x, y, cw, ch);
          ctx.restore();
        }
      }

      for (const t of hot.textItems) drawTextItem(ctx, t);

      if (hot.typing) {
        const preview = {
          x: hot.typing.x,
          y: hot.typing.y,
          text: hot.typing.text || '',
          font: FONTS[fontIndex],
          size: Number(sizeInput?.value || 16),
          color: colorInput?.value || '#ffffff',
          selected: false
        };
        drawTextItem(ctx, preview, true);
        ctx.save();
        ctx.fillStyle = preview.color;
        const w = ctx.measureText(preview.text).width;
        ctx.fillRect(preview.x + w + 1, preview.y, 1, preview.size * 1.2);
        ctx.restore();
      }

      // SHAPE preview overlay
      if (hot.shapePreview) {
        const sp  = hot.shapePreview;
        const c   = ctx;
        let x1 = sp.x1, y1 = sp.y1, x2 = sp.x2, y2 = sp.y2;
        let left = Math.min(x1, x2);
        let top  = Math.min(y1, y2);
        let w    = Math.abs(x2 - x1);
        let h    = Math.abs(y2 - y1);

        c.save();
        c.strokeStyle = colorInput?.value || '#000000';
        c.lineWidth   = Number(sizeInput?.value || 3) * 2;
        c.setLineDash([4,4]);
        c.beginPath();
        if (hot.shapeMode === 'circle') {
          const cx = left + w / 2;
          const cy = top  + h / 2;
          const rx = w / 2;
          const ry = h / 2;
          c.ellipse(cx, cy, rx, ry, 0, 0, Math.PI * 2);
        } else {
          c.rect(left, top, w, h);
        }
        c.stroke();
        c.restore();
      }

      // LINE preview overlay
      if (hot.linePreview) {
        const lp = hot.linePreview;
        const c = ctx;
        c.save();
        c.strokeStyle = colorInput?.value || '#000000';
        c.lineWidth   = Number(sizeInput?.value || 3) * 2;
        c.lineCap     = 'round';
        c.setLineDash([4,4]);
        c.beginPath();
        c.moveTo(lp.x1, lp.y1);
        c.lineTo(lp.x2, lp.y2);
        c.stroke();
        c.restore();
      }

      requestAnimationFrame(render);
    }
    requestAnimationFrame(render);
  })();
  </script>

  <!-- Type tool + magazine mode + tool wiring -->
  <script>
  (function(){
    const root   = document.getElementById('win-design');
    const canvas = document.getElementById('canvas');
    if (!root || !canvas) return;

    const FONTS = ['Arial', 'Georgia', 'Impact', 'Verdana', 'Courier New', 'Trebuchet MS', 'Times New Roman'];
    let fontIndex = 0;

    const fontPrev = document.getElementById('font-prev');
    const fontNext = document.getElementById('font-next');
    const fontName = document.getElementById('font-name');
    const typeBtn  = document.getElementById('type');
    const colorEl  = document.getElementById('color');
    const sizeEl   = document.getElementById('size');

    if (sizeEl) {
      sizeEl.addEventListener('input', () => {
        const hot = window.__designHot;
        if (!hot || !hot.textItems) return;
        hot.textItems.forEach(t => {
          if (t.selected) {
            t.size = Number(sizeEl.value || 16);
          }
        });
      });
    }

    if (fontName) fontName.textContent = FONTS[fontIndex];

    if (!window.__designHot) window.__designHot = {};
    const hot = window.__designHot;

    // === Magazine mode helper ===
    window.setMagazineMode = function(enabled){
  const canvas = document.getElementById('canvas');
  const hot    = window.__designHot;
  if (!canvas || !hot) return;

  // INTERNAL resolution
  const W = enabled ? 500 : 1280;
  const H = enabled ? 800 : 720;

  // Resize internal pixel buffer
  canvas.width  = W;
  canvas.height = H;

  // Resize visible CSS box
  if (enabled) {
    // magazine mode: tall page
    canvas.style.width  = '500px';
    canvas.style.height = '800px';
    canvas.style.aspectRatio = '500 / 800';
  } else {
    // normal mode: keep 16:9 aspect ratio and scale by width
    canvas.style.width  = '100%';
    canvas.style.height = 'auto';          // ‚úÖ was "100%" (caused stretch)
    canvas.style.aspectRatio = '16 / 9';   // keep circles circular
  }


  // Resize offscreen paint canvas
  let paint = hot.paint;
  if (!paint) {
    paint = document.createElement('canvas');
    hot.paint = paint;
  }
  paint.width  = W;
  paint.height = H;

  const pctx = paint.getContext('2d');
  pctx.fillStyle = '#faf8e8';
  pctx.fillRect(0, 0, W, H);

  hot.pctx = pctx;
};


function setTool(name){
  hot.tool = name;

  // --- track which tools were used this attempt ---
  if (!hot.usedToolsArr) hot.usedToolsArr = [];
  if (name && !hot.usedToolsArr.includes(name)) {
    hot.usedToolsArr.push(name);
  }

  const ids = ['pen','bucket','type','eraser','shape','open-assets','line','move','undo','picker','clear','upload'];
  ids.forEach(id=>{
    const btn = document.getElementById(id);
    if (!btn) return;
    const toolName =
      id === 'pen'   ? 'pen'   :
      id === 'bucket'? 'bucket':
      id === 'type'  ? 'type'  :
      id === 'eraser'? 'eraser':
      id === 'picker'? 'picker':
      id === 'move'  ? 'move'  :
      id === 'line'  ? 'line'  :
      id === 'shape' ? 'shape' :
      null;
    btn.classList.toggle('active', toolName === name);
  });
}


    document.getElementById('pen')   ?.addEventListener('click', ()=> setTool('pen'));
    document.getElementById('eraser')?.addEventListener('click', ()=> setTool('eraser'));
    document.getElementById('bucket')?.addEventListener('click', ()=> setTool('bucket'));
    document.getElementById('picker')?.addEventListener('click', ()=> setTool('picker'));
    document.getElementById('move')  ?.addEventListener('click', ()=> setTool('move'));
    document.getElementById('line')  ?.addEventListener('click', ()=> setTool('line'));
    typeBtn?.addEventListener('click', ()=> setTool('type'));
    window.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='t') setTool('type'); });

    const shapeBtn = document.getElementById('shape');
    shapeBtn?.addEventListener('click', ()=>{
      const choice = window.prompt(
        'Choose shape:\n- type "c" for circle/ellipse\n- type "s" for square/rectangle',
        'c'
      );

      if (choice && choice.toLowerCase().startsWith('c')) {
        hot.shapeMode = 'circle';
      } else {
        hot.shapeMode = 'rect';
      }

      setTool('shape');
    });

    function updateFontLabel(){
      if(fontName) fontName.textContent = (window.__designHotFont || 'Arial');
    }
    window.__designHotFont = FONTS[fontIndex];
    updateFontLabel();

    fontPrev?.addEventListener('click', ()=>{
      fontIndex = (fontIndex - 1 + FONTS.length) % FONTS.length;
      window.__designHotFont = FONTS[fontIndex];
      updateFontLabel();
    });
    fontNext?.addEventListener('click', ()=>{
      fontIndex = (fontIndex + 1) % FONTS.length;
      window.__designHotFont = FONTS[fontIndex];
      updateFontLabel();
    });
  })();
  </script>

  <!-- Sticker helpers -->
  <script>
  (function(){
    window.addStickerImage = function(img){
      const canvas = document.getElementById('canvas');
      const hot = (window.__designHot ||= { stickers: [] });
      const maxSide = 256;
      let w = img.naturalWidth, h = img.naturalHeight;
      const s = Math.min(1, maxSide / Math.max(w, h));
      w = Math.round(w * s); h = Math.round(h * s);
      hot.stickers.push({
        img, x: canvas.width/2, y: canvas.height/2,
        w, h, scale: 1, selected: false
      });
      hot.tool = 'move';
      document.getElementById('move')?.classList.add('active');
      ['pen','eraser','bucket','picker','type']
        .forEach(id => document.getElementById(id)?.classList.remove('active'));
    };

    window.addStickerFromURL = function(url){
      const canvas = document.getElementById('canvas');
      if(!canvas) return;
      const img = new Image();
      img.onload = () => window.addStickerImage(img);
      img.onerror = () => {
        alert(`I couldn't load ${url}. If you're opening the HTML with file://, use a local server (e.g. npx serve) so images load consistently.`);
      };
      img.src = url;
    };
  })();
  </script>

<!-- Design UI wiring for new layout (Upload + swatches/clear/undo) -->
<script>
  (function () {
    const hot        = (window.__designHot ||= {});
    const colorInput = document.getElementById('color');

    // Color swatches -> visible colors + hidden color input
    const swatches = document.querySelectorAll('.swatch');
    swatches.forEach((btn, idx) => {
      const c = btn.dataset.color || '#000000';
      btn.style.backgroundColor = c;

      btn.addEventListener('click', () => {
        if (colorInput) colorInput.value = c;

        // Track swatch index so we can judge relationships
        if (!hot.usedColorIndicesArr) hot.usedColorIndicesArr = [];
        hot.usedColorIndicesArr.push(idx); // 0‚Äì11
      });
    });

    // Clear: wipe canvas + remove stickers/text + metrics
    document.getElementById('clear')?.addEventListener('click', () => {
      const h = window.__designHot;
      if (!h || !h.pctx || !h.paint) return;

      h.pctx.fillStyle = '#faf8e8';
      h.pctx.fillRect(0, 0, h.paint.width, h.paint.height);

      if (h.stickers)  h.stickers.length  = 0;
      if (h.textItems) h.textItems.length = 0;

      // Reset metrics arrays
      h.usedColorIndicesArr = [];
      h.usedFontsArr        = [];
      h.usedToolsArr        = [];
    });

    // Undo: last text OR last sticker
    document.getElementById('undo')?.addEventListener('click', () => {
      const h = window.__designHot;
      if (!h) return;

      if (h.textItems && h.textItems.length) {
        h.textItems.pop();
        return;
      }
      if (h.stickers && h.stickers.length) {
        h.stickers.pop();
        return;
      }
      alert('Nothing to undo yet (paint strokes undo is a future upgrade).');
    });
  })();
</script>


<!-- Brief scoring helpers (no attempt tracking here) -->
<script>
  function getHot() {
    return window.__designHot || {};
  }

  // FLOWER HAUS: must use at least 3 different tools
  function evaluateFlowerDesign() {
    const hot   = getHot();
    const tools = hot.usedToolsArr || [];
    const unique = new Set(tools);
    return unique.size >= 3;
  }

  // PAUL: cannot use Pen; must use one of three exact color triads
// Triads are defined using swatch indices:
// 0 = red, 1 = orange, 2 = yellow, 3 = green, 4 = blue, 6 = purple
function evaluatePaulDesign() {
  const hot   = getHot();
  const tools = hot.usedToolsArr        || [];
  const idxs  = hot.usedColorIndicesArr || [];

  // 1) No Pen tool allowed
  if (tools.includes('pen')) return false;

  // 2) Exactly 3 distinct colors used
  const unique = [...new Set(idxs)];
  if (unique.length !== 3) return false;

  // sort so order doesn't matter
  const sorted = unique.slice().sort((a, b) => a - b);

  // Allowed triads by swatch index:
  // (red, blue, yellow)          -> [0, 2, 4]
  // (purple, green, orange)      -> [1, 3, 6]
  // (yellow, purple, orange)     -> [1, 2, 6]
  const allowedTriads = [
    [0, 2, 4],
    [1, 3, 6],
    [1, 2, 6]
  ];

  return allowedTriads.some(triad =>
    triad.length === sorted.length &&
    triad.every((v, i) => v === sorted[i])
  );
}


  // APRIL: analogous colors + at least 3 assets
  function evaluateAprilDesign() {
    const hot      = getHot();
    const stickers = hot.stickers || [];
    const idxs     = hot.usedColorIndicesArr || [];
    const unique   = [...new Set(idxs)];

    if (stickers.length < 3) return false;
    if (unique.length < 2)   return false;

    const min = Math.min(...unique);
    const max = Math.max(...unique);
    return (max - min) <= 3; // close together on the strip
  }

  // TANAKA: complementary-ish colors, ‚â§1 asset, must use sans serif
  function evaluateTanakaDesign() {
    const hot      = getHot();
    const stickers = hot.stickers || [];
    const idxs     = hot.usedColorIndicesArr || [];
    const fonts    = hot.usedFontsArr        || [];

    // ‚â§ 1 asset
    if (stickers.length > 1) return false;

    // Need at least 2 different colors
    const unique = [...new Set(idxs)];
    if (unique.length < 2) return false;

    // warm vs cool grouping on our 12-swatch strip
    const warmSet = new Set([0,1,2,7,8]);   // reds/oranges/yellows/browns
    const coolSet = new Set([3,4,5,6]);     // greens/blues/purples

    const hasWarm = unique.some(i => warmSet.has(i));
    const hasCool = unique.some(i => coolSet.has(i));
    if (!hasWarm || !hasCool) return false;

    // Must use sans serif font
    const sansSet = new Set(["Arial","Impact","Verdana","Trebuchet MS"]);
    const usesSans = fonts.some(f => sansSet.has(f));
    if (!usesSans) return false;

    return true;
  }
</script>



  
  
<script>
  (function(){
    const uploadBtn = document.getElementById('upload');
    if (!uploadBtn) return;

    // Track attempts per brief
    if (!window.briefAttempts) {
      window.briefAttempts = {
        flower: 0,
        paul:   0,
        april:  0,
        tanaka: 0
      };
    }

    function resetBriefState(key) {
      const hot = window.__designHot || {};
      // Clear stats so next attempt starts fresh
      if (window.resetDesignStats) window.resetDesignStats();

      if (key === 'flower') {
        window.flowerHausJobActive   = false;
        window.flowerHausJobComplete = false;
      }
      if (key === 'paul') {
        window.paulJobActive   = false;
        window.paulJobComplete = false;
      }
      if (key === 'april') {
        window.aprilJobActive   = false;
        window.aprilJobComplete = false;
      }
      if (key === 'tanaka') {
        window.tanakaJobActive   = false;
        window.tanakaJobComplete = false;
      }
    }

    function handleFail(key, clientName) {
  const attempts = window.briefAttempts;
  attempts[key] = (attempts[key] || 0) + 1;

  const used      = attempts[key];
  const remaining = Math.max(0, 3 - used);
  const isFinal   = used >= 3;

  // Trigger client-specific fail dialogue with hints
  if (key === "flower" && typeof window.startFlowerHausFailDialogue === "function") {
    window.startFlowerHausFailDialogue(remaining, isFinal);
  } else if (key === "paul" && typeof window.startPaulFailDialogue === "function") {
    window.startPaulFailDialogue(remaining, isFinal);
  } else if (key === "april" && typeof window.startAprilFailDialogue === "function") {
    window.startAprilFailDialogue(remaining, isFinal);
  } else if (key === "tanaka" && typeof window.startTanakaFailDialogue === "function") {
    window.startTanakaFailDialogue(remaining, isFinal);
  } else {
    // Fallback if something goes wrong
    const msg = isFinal
      ? clientName + " has rejected the project after 3 attempts. The brief has been reset."
      : clientName + " isn‚Äôt satisfied yet. (" + used + "/3 attempts used)";
    alert(msg);
  }

  // On 3rd failure, reset that brief for a fresh start
  if (isFinal) {
    attempts[key] = 0;
    resetBriefState(key);
  }
}


    uploadBtn.addEventListener('click', () => {
      let handled = false;

      // 1) Flower Haus brief
      if (
        window.flowerHausJobActive &&
        !window.flowerHausJobComplete
      ) {
        if (evaluateFlowerDesign()) {
          const ok = confirm('Submit this design to the Flower Haus client?');
          if (ok && typeof window.startFlowerHausCompleteDialogue === 'function') {
            window.startFlowerHausCompleteDialogue();
            window.briefAttempts.flower = 0;
            handled = true;
          }
        } else {
          handleFail('flower','Griffin');
          handled = true;
        }
      }

      // 2) Paul logo brief
      if (
        !handled &&
        window.paulJobActive &&
        !window.paulJobComplete
      ) {
        if (evaluatePaulDesign()) {
          const ok = confirm("Submit this design for Paul‚Äôs Computer Co. logo?");
          if (ok && typeof window.startPaulCompleteDialogue === 'function') {
            window.startPaulCompleteDialogue();
            window.briefAttempts.paul = 0;
            handled = true;
          }
        } else {
          handleFail('paul','Paul');
          handled = true;
        }
      }

      // 3) April art show poster
      if (
        !handled &&
        window.aprilJobActive &&
        !window.aprilJobComplete
      ) {
        if (evaluateAprilDesign()) {
          const ok = confirm("Submit this design for April‚Äôs art show poster?");
          if (ok && typeof window.startAprilCompleteDialogue === 'function') {
            window.startAprilCompleteDialogue();
            window.briefAttempts.april = 0;
            handled = true;
          }
        } else {
          handleFail('april','April');
          handled = true;
        }
      }

      // 4) Tanaka film poster
      if (
        !handled &&
        window.tanakaJobActive &&
        !window.tanakaJobComplete
      ) {
        if (evaluateTanakaDesign()) {
          const ok = confirm("Submit your poster design to Ikko Tanaka?");
          if (ok && typeof window.startTanakaCompleteDialogue === 'function') {
            window.startTanakaCompleteDialogue();
            window.briefAttempts.tanaka = 0;
            handled = true;
          }
        } else {
          handleFail('tanaka','Ikko Tanaka');
          handled = true;
        }
      }

      // 5) Commissions (leave as-is, no scoring rules yet)
      if (
        !handled &&
        window.activeCommissionId &&
        typeof window.markActiveCommissionCompleted === 'function'
      ) {
        const ok = confirm('Submit this design to complete your current commission?');
        if (ok) {
          window.markActiveCommissionCompleted();
          handled = true;
        }
      }

      if (!handled) {
        alert('There is no active client brief or commission to submit yet.');
      }
    });
  })();
</script>

   <!-- Web app logic (with color theory + back button + client pages) -->
   <script>
    (function(){
      const homePage       = document.getElementById('web-home');
      const principlesPage = document.getElementById('web-principles');
      const colorPage      = document.getElementById('web-color');
      const clientPage     = document.getElementById('web-client');
      const clientImg      = document.getElementById('client-img');
      const clientNextBtn  = document.getElementById('client-next');
  
      const tabTitle       = document.getElementById('web-tab-title');
      const searchInput    = document.getElementById('web-search-input');
      const searchBtn      = document.getElementById('web-search-btn');
      const backBtn        = document.getElementById('web-back');
  
      if (!homePage || !principlesPage || !colorPage || !clientPage) return;
  
      // ----- CLIENTPEDIA PNGs -----
      const CLIENT_PAGES = [
        "./assets/ui/April_Greiman_Bio.png",
        "./assets/ui/Paul_Rand_Bio.png",
        "./assets/ui/Ikko_Tanaka_Bio.png"
      ];
      let clientIndex = 0;
  
      function setClientImage(idx){
        clientIndex = (idx + CLIENT_PAGES.length) % CLIENT_PAGES.length;
        if (clientImg) {
          clientImg.src = CLIENT_PAGES[clientIndex];
        }
      }
  
      // ----- PAGE SWITCHER -----
      function showPage(name){
        homePage.classList.add('hidden');
        principlesPage.classList.add('hidden');
        colorPage.classList.add('hidden');
        clientPage.classList.add('hidden');
  
        if (name === 'principles') {
          principlesPage.classList.remove('hidden');
          tabTitle.textContent = 'Principles of design';
          backBtn.classList.remove('hidden');
        } else if (name === 'color') {
          colorPage.classList.remove('hidden');
          tabTitle.textContent = 'Color Theory';
          backBtn.classList.remove('hidden');
        } else if (name === 'client') {
          clientPage.classList.remove('hidden');
          tabTitle.textContent = 'Client research';
          backBtn.classList.remove('hidden');
        } else {
          homePage.classList.remove('hidden');
          tabTitle.textContent = 'New tab';
          backBtn.classList.add('hidden');
        }
      }
  
      showPage('home');
  
      // ----- SUGGESTED SEARCH BUTTONS -----
      document.querySelectorAll('.web-suggest').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const target = btn.getAttribute('data-web-search');
          if (target === 'principles') {
            showPage('principles');
          } else if (target === 'color') {
            showPage('color');
          } else if (target === 'client') {
            setClientImage(0);     // start on April
            showPage('client');
          } else {
            alert('That search result is coming soon ‚Äì for now, "client research", "principles of design", and "color theory" are implemented.');
          }
        });
      });
  
      // ----- SIMPLE SEARCH (optional / limited) -----
      function runSearch(){
        const q = (searchInput.value || '').toLowerCase();
        if (!q) return;
        if (q.includes('principle')) {
          showPage('principles');
        } else if (q.includes('color')) {
          showPage('color');
        } else if (q.includes('client')) {
          setClientImage(0);
          showPage('client');
        } else {
          alert('In this prototype, the Web app has pages for "client research", "principles of design", and "color theory".');
        }
      }
  
      searchBtn?.addEventListener('click', runSearch);
      searchInput?.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter') runSearch();
      });
  
      backBtn?.addEventListener('click', ()=> showPage('home'));
      tabTitle?.addEventListener('click', ()=> showPage('home'));
  
      window.webShowHome = () => showPage('home');
  
      // ----- NEXT CLIENT BUTTON -----
      if (clientNextBtn) {
        clientNextBtn.addEventListener('click', () => {
          setClientImage(clientIndex + 1); // advance to next PNG
        });
      }
    })();
    </script>
    <script>
  window.resetDesignStats = function () {
    const hot = (window.__designHot ||= {});
    hot.usedToolsArr        = [];
    hot.usedColorIndicesArr = [];
    hot.usedFontsArr        = [];
  };
</script>

  

 <!-- Flower Haus / Paul / April / Tanaka dialogue system -->
<script>
  (function () {
    const layer   = document.getElementById("dialogue-layer");
    const faceImg = document.getElementById("dialogue-face");
    const textEl  = document.getElementById("dialogue-text");
    const nameEl  = document.getElementById("dialogue-name");

    if (!layer || !faceImg || !textEl || !nameEl) return;

    // ---------- FLOWER HAUS (Griffin) ----------
    const FLOWER_HAUS_BRIEF_DIALOGUE = [
      {
        face: "./assets/ui/IMG_0253.png",
        text:
          "Hey! Thanks for accepting my brief. I know its short notice but this magazine is my love letter to Graphic Design and I need it to be perfect."
      },
      {
        face: "./assets/ui/IMG_0212.png",
        text:
          "I know this is your first job so I'm going to keep things real simple, by giving you complete creative freedom. Don't get used to this though, most clients will be a lot more picky!"
      },
      {
        face: "./assets/ui/IMG_0256.png",
        text:
          "You can experiment with every color scheme and design principle and tool available. Before you submit make sure you spend some time brushing up on the basics in the Web search app. Let‚Äôs make this cover iconic."
      }
    ];

    const FLOWER_HAUS_COMPLETE_DIALOGUE = [
      {
        face: "./assets/ui/IMG_0212.png",
        text:
          "Whoa, that cover looks incredible. It really feels like Flower Haus has its own voice now."
      },
      {
        face: "./assets/ui/IMG_0256.png",
        text:
          "You nailed the hierarchy and the palette feels so cohesive. This is exactly what I was hoping for."
      },
      {
        face: "./assets/ui/IMG_0253.png",
        text:
          "I‚Äôve sent over your payment for the job! Consider this cover officially approved. Can‚Äôt wait to work with you again."
      }
    ];

    // ---------- PAUL (logo brief) ----------
    const PAUL_ACCEPT_DIALOGUE = [
      {
        face: "./assets/ui/Paul_1.png",
        text:
          "Thanks for taking this on. I need a mark for my computer company that‚Äôs as clear as it is memorable."
      },
      {
        face: "./assets/ui/Paul_2.png",
        text:
          "Think in terms of geometry and structure; circles, squares, lines, nothing done freehand. No superfluous decorations."
      },
      {
        face: "./assets/ui/Paul_3.png",
        text:
          "If it still reads perfectly at the size of a postage stamp, we‚Äôre on the right track."
      }
    ];

    const PAUL_COMPLETE_DIALOGUE = [
      {
        face: "./assets/ui/Paul_2.png",
        text:
          "That‚Äôs exactly the kind of form I was hoping for‚Ä¶..It feels inevitable, like it‚Äôs always existed."
      },
      {
        face: "./assets/ui/Paul_3.png",
        text:
          "Good use of typeface and negative space. Really strong work. You must've done your research."
      },
      {
        face: "./assets/ui/Paul_1.png",
        text:
          "Payment‚Äôs on its way. Thanks again for the thoughtful design."
      }
    ];

    // ---------- APRIL (art show poster) ----------
    const APRIL_ACCEPT_DIALOGUE = [
      {
        face: "./assets/ui/April_1.png",
        text:
          "Hi! I‚Äôm putting together an art show that mixes print, video, and digital experiments. I need the poster to feel just as experimental."
      },
      {
        face: "./assets/ui/April_2.png",
        text:
          "Play with type, grids, and color like they‚Äôre living in a digital space ‚Äî overlaps, diagonals, unexpected scale shifts are all welcome."
      },
      {
        face: "./assets/ui/April_3.png",
        text:
          "Just make sure the show title, date, time, and location stay readable. Beyond that, push it as far as you‚Äôd like."
      }
    ];

    const APRIL_COMPLETE_DIALOGUE = [
      {
        face: "./assets/ui/April_2.png",
        text:
          "This looks amazing. It feels like the poster itself is in motion."
      },
      {
        face: "./assets/ui/April_3.png",
        text:
          "The way you handled type and color really captures the spirit of the show."
      },
      {
        face: "./assets/ui/April_1.png",
        text:
          "I‚Äôve sent over your payment. Thanks for helping bring this exhibition to life."
      }
    ];

    // ---------- TANAKA (film poster) ----------
    const TANAKA_ACCEPT_DIALOGUE = [
      {
        face: "./assets/ui/IMG_0247.jpg",
        text:
          "Thank you for accepting my brief. This film is deeply personal, and the poster must reflect clarity and strong form."
      },
      {
        face: "./assets/ui/IMG_0249.jpg",
        text:
          "Focus on balance, geometry, and a calm sense of control. A poster that is readable, structured, and harmonious."
      },
      {
        face: "./assets/ui/IMG_0248.jpg",
        text:
          "Let the shapes do the speaking. I am excited to see what you create."
      }
    ];

    const TANAKA_COMPLETE_DIALOGUE = [
      {
        face: "./assets/ui/IMG_0247.jpg",
        text:
          "This poster speaks with clarity and confidence. Your composition is excellent."
      },
      {
        face: "./assets/ui/IMG_0248.jpg",
        text:
          "You captured the spirit of the film without excess detail. Beautifully done."
      },
      {
        face: "./assets/ui/IMG_0247.jpg",
        text:
          "Payment has been sent. I hope we can work together again soon."
      }
    ];

    // ---------- shared dialogue runner ----------
    let current      = 0;
    let activeScript = null;
    let onDone       = null;

    function showLine() {
      if (!activeScript || current >= activeScript.length) {
        layer.classList.add("hidden");
        const cb = onDone;
        activeScript = null;
        onDone = null;
        if (cb) cb();
        return;
      }

      const line = activeScript[current];
      if (line.face) faceImg.src = line.face;
      textEl.textContent = line.text;
    }

    function startDialogue(script, speakerName, doneCb) {
      activeScript = script;
      current      = 0;
      onDone       = doneCb || null;
      nameEl.textContent = speakerName || "Client";
      layer.classList.remove("hidden");
      showLine();
    }

    layer.addEventListener("click", function () {
      if (!activeScript) return;
      current++;
      showLine();
    });

    // ---------- ACCEPT / COMPLETE HELPERS ----------
    window.startFlowerHausDialogue = function () {
      startDialogue(FLOWER_HAUS_BRIEF_DIALOGUE, "Griffin Flowers", function () {
        if (typeof window.setMagazineMode === "function") {
          window.setMagazineMode(true);
        }
        window.flowerHausJobActive   = true;
        window.flowerHausJobComplete = false;
        window.resetDesignStats && window.resetDesignStats();
      });
    };

    window.startFlowerHausCompleteDialogue = function () {
      startDialogue(FLOWER_HAUS_COMPLETE_DIALOGUE, "Griffin Flowers", function () {
        window.flowerHausJobComplete = true;
        if (typeof window.cashAddIncome === "function") {
          window.cashAddIncome(500, "Flower Haus Cover");
        }
      });
    };

    window.startPaulDialogue = function () {
      startDialogue(PAUL_ACCEPT_DIALOGUE, "Paul", function () {
        window.paulJobActive   = true;
        window.paulJobComplete = false;
        window.resetDesignStats && window.resetDesignStats();
      });
    };

    window.startPaulCompleteDialogue = function () {
      startDialogue(PAUL_COMPLETE_DIALOGUE, "Paul", function () {
        window.paulJobComplete = true;
        if (typeof window.cashAddIncome === "function") {
          window.cashAddIncome(350, "Paul‚Äôs Computer Logo");
        }
      });
    };

    window.startAprilDialogue = function () {
      startDialogue(APRIL_ACCEPT_DIALOGUE, "April", function () {
        window.aprilJobActive   = true;
        window.aprilJobComplete = false;
        window.resetDesignStats && window.resetDesignStats();
      });
    };

    window.startAprilCompleteDialogue = function () {
      startDialogue(APRIL_COMPLETE_DIALOGUE, "April", function () {
        window.aprilJobComplete = true;
        if (typeof window.cashAddIncome === "function") {
          window.cashAddIncome(400, "April Art Show Poster");
        }
      });
    };

    window.startTanakaDialogue = function () {
      startDialogue(TANAKA_ACCEPT_DIALOGUE, "Ikko Tanaka", function () {
        window.tanakaJobActive   = true;
        window.tanakaJobComplete = false;
        window.resetDesignStats && window.resetDesignStats();
      });
    };

    window.startTanakaCompleteDialogue = function () {
      startDialogue(TANAKA_COMPLETE_DIALOGUE, "Ikko Tanaka", function () {
        window.tanakaJobComplete = true;
        if (typeof window.cashAddIncome === "function") {
          window.cashAddIncome(450, "Ikko Tanaka ‚Äì Film Poster");
        }
      });
    };

    // ---------- FAIL DIALOGUES WITH HINTS ----------
    window.startFlowerHausFailDialogue = function (remaining, isFinal) {
      const hintText = isFinal
        ? "We‚Äôve tried a few versions now, so I‚Äôm going to reset the brief. Next time, make sure you experiment with at least three different tools in the design app before you upload."
        : `We‚Äôre not quite there yet. Try using at least three different tools on the cover ‚Äî brush, shapes, text, assets, lines‚Ä¶ really explore the interface. You have ${remaining} more attempt(s) before I reset the brief.`;

      const script = [
        {
          face: "./assets/ui/IMG_0212.jpg",
          text: "Hmm, this version of the Flower Haus cover isn‚Äôt quite working yet."
        },
        {
          face: "./assets/ui/IMG_0213.jpg",
          text: hintText
        }
      ];
      startDialogue(script, "Griffin Flowers");
    };

    window.startPaulFailDialogue = function (remaining, isFinal) {
      const hintText = isFinal
        ? "Let‚Äôs reset this project. When you try again, avoid the freehand pen, pick exactly three colors, and keep them in a clean geometric relationship."
        : `This logo still isn‚Äôt quite right. Remember: don‚Äôt use the Pen tool, and limit yourself to exactly three colors that are evenly spaced ‚Äî a strong triad. You have ${remaining} more attempt(s) left.`;

      const script = [
        {
          face: "./assets/ui/Paul_1.png",
          text: "This version doesn‚Äôt quite have the structure I‚Äôm looking for."
        },
        {
          face: "./assets/ui/Paul_2.png",
          text: "Think in terms of geometry and clarity. No loose, freehand drawing for this one."
        },
        {
          face: "./assets/ui/Paul_3.png",
          text: hintText
        }
      ];
      startDialogue(script, "Paul");
    };

    window.startAprilFailDialogue = function (remaining, isFinal) {
      const hintText = isFinal
        ? "I‚Äôm going to reset the brief so you can start fresh. Next time, place at least three assets and keep your colors close together, like neighbors on the spectrum."
        : `We‚Äôre close, but the poster isn‚Äôt quite capturing the show yet. Try using analogous colors ‚Äî hues that sit near each other ‚Äî and make sure you place at least three assets. You have ${remaining} more attempt(s) left.`;

      const script = [
        {
          face: "./assets/ui/April_1.png",
          text: "This version doesn‚Äôt feel as cohesive or experimental as I‚Äôd like."
        },
        {
          face: "./assets/ui/April_2.png",
          text: "Push the layout, but keep the color story tight and related."
        },
        {
          face: "./assets/ui/April_3.png",
          text: hintText
        }
      ];
      startDialogue(script, "April");
    };

    window.startTanakaFailDialogue = function (remaining, isFinal) {
      const hintText = isFinal
        ? "I will reset the brief so you can rethink the composition. Next time, keep the palette focused on a warm + cool contrast, use no more than a single asset, and choose a clear sans serif typeface."
        : `The poster still needs more clarity. Try combining one warm color with one cool color, use no more than one asset, and make sure your type uses a sans serif font. You have ${remaining} attempt(s) left.`;

      const script = [
        {
          face: "./assets/ui/IMG_0249.jpg",
          text: "This version of the poster doesn‚Äôt yet have the balance and contrast I‚Äôm looking for."
        },
        {
          face: "./assets/ui/IMG_0248.jpg",
          text: "Think about calm geometry and a clear dialogue between warm and cool colors."
        },
        {
          face: "./assets/ui/IMG_0247.jpg",
          text: hintText
        }
      ];
      startDialogue(script, "Ikko Tanaka");
    };
  })();
</script>



  <!-- Slider also controls selected sticker scale -->
  <script>
  (function () {
    const sizeEl = document.getElementById('size');
    if (!sizeEl) return;

    sizeEl.addEventListener('input', () => {
      const hot = window.__designHot;
      if (!hot || !Array.isArray(hot.stickers)) return;

      const selected = hot.stickers.filter(s => s.selected);
      if (!selected.length) return;

      const v = Number(sizeEl.value || 1);
      const scale = Math.max(0.2, Math.min(3, v / 10));

      selected.forEach(s => {
        s.scale = scale;
      });
    });
  })();
  </script>

  <!-- Background music (no mute button) -->
  <audio id="bgm" src="./assets/audio/title_music.mp3" loop></audio>

  <!-- Title ‚Üí Explanation ‚Üí Game flow + music -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const frame             = document.querySelector('.frame');
    const titleScreen       = document.getElementById('title-screen');
    const explanationScreen = document.getElementById('explanation-screen');
    const playBtn           = document.getElementById('title-play-btn'); // Play Game button
    const bgm               = document.getElementById('bgm');

    // Start state: show title, hide game + explanation
    if (frame) frame.style.display = 'none';
    if (titleScreen) titleScreen.classList.remove('hidden');
    if (explanationScreen) explanationScreen.classList.add('hidden');

    function startMusic() {
      if (!bgm) return;
      bgm.volume = 0.5;
      bgm.play().catch(err => {
        console.log('Audio play blocked until user gesture:', err);
      });
    }

    // STEP 1: Play Game ‚Üí explanation PNG
    if (playBtn) {
      playBtn.addEventListener('click', () => {
        if (titleScreen) titleScreen.classList.add('hidden');
        if (explanationScreen) explanationScreen.classList.remove('hidden');
        startMusic();
      });
    }

    // STEP 2: Click explanation ‚Üí into the game
    if (explanationScreen && frame) {
      explanationScreen.addEventListener('click', () => {
        explanationScreen.classList.add('hidden');
        frame.style.display = 'block';
      });
    }
  });
  </script>

  <!-- Clamp windows inside the fake screen after dragging -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const screen = document.getElementById('screen');
    if (!screen) return;

    function clampWindow(win) {
      const parent = win.offsetParent || screen;
      const maxX = parent.clientWidth  - win.offsetWidth;
      const maxY = parent.clientHeight - win.offsetHeight;

      let left = win.offsetLeft;
      let top  = win.offsetTop;

      if (maxX < 0 || maxY < 0) return; // window bigger than screen

      if (left < 0) left = 0;
      if (top  < 0) top  = 0;
      if (left > maxX) left = maxX;
      if (top  > maxY) top  = maxY;

      win.style.left = left + 'px';
      win.style.top  = top  + 'px';
    }

    function clampAllWindows() {
      document.querySelectorAll('.win').forEach(w => {
        if (!w.classList.contains('hidden')) clampWindow(w);
      });
    }

    // After any mouseup (drag stop), snap windows fully inside the blue screen
    window.addEventListener('mouseup', clampAllWindows);

    // Also clamp once at startup in case defaults are off-screen
    clampAllWindows();
  });
  </script>
  <script>
    (function () {
      const briefsList = document.getElementById('briefs-list');
      if (!briefsList) return;
  
      briefsList.innerHTML = `
        <div class="briefs-expl-wrap">
          <img
            src="./assets/ui/explanation_page.png"
            alt="Explanation Page"
            class="briefs-expl-img"
          />
        </div>
      `;
    })();
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const assetBtn = document.getElementById('open-assets');
      const assetWin = document.getElementById('win-asset-browser');
      if (!assetBtn || !assetWin) return;
    
      assetBtn.addEventListener('click', () => {
        // show the window
        assetWin.classList.remove('hidden');
        assetWin.style.display = 'block';
    
        // bring it to the front over other app windows
        const wins = document.querySelectorAll('.win');
        let maxZ = 10;
        wins.forEach(w => {
          const z = parseInt(getComputedStyle(w).zIndex || '10', 10);
          if (z > maxZ) maxZ = z;
        });
        assetWin.style.zIndex = maxZ + 1;
      });
    });
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const grid  = document.getElementById('asset-grid');
        const input = document.getElementById('asset-filter');
        if (!grid) return;
      
        // üîπ UPDATE THESE PATHS / LABELS TO MATCH YOUR REAL ASSET FILES
        const ASSETS = [
          { label: '', url: './assets/ui/asset_8.png' },
          { label: '', url: './assets/ui/asset_9.png' },
          { label: '', url: './assets/ui/asset_10.png' },
          { label: '', url: './assets/ui/asset_11.png' },
          { label: '', url: './assets/ui/asset_12.png' },
          { label: '', url: './assets/ui/asset_13.png' },
          { label: '', url: './assets/ui/asset_3.png' },
          { label: '', url: './assets/ui/asset_4.png' },
          { label: '', url: './assets/ui/asset_5.png' },
          { label: '', url: './assets/ui/asset_6.png' },
          { label: '', url: './assets/ui/asset_7.png' },
          { label: '', url: './assets/ui/asset_14.png' },
          { label: '', url: './assets/ui/asset_15.png' },
          { label: '', url: './assets/ui/asset_16.png' },
          { label: '', url: './assets/ui/asset_17.png' },
          { label: '', url: './assets/ui/asset_18.png' },
          { label: '', url: './assets/ui/asset_19.png' },
          { label: '', url: './assets/ui/asset_20.png' },
          { label: '', url: './assets/ui/asset_21.png' },
          { label: '', url: './assets/ui/asset_22.png' }
          
        ];
      
        function renderGrid(filterText = '') {
          const q = filterText.toLowerCase();
          grid.innerHTML = '';
      
          ASSETS
            .filter(a => !q || a.label.toLowerCase().includes(q))
            .forEach(asset => {
              const btn = document.createElement('button');
              btn.className = 'asset-thumb';
              btn.title = asset.label;
      
              const img = document.createElement('img');
              img.src = asset.url;
              img.alt = asset.label;
      
              const cap = document.createElement('div');
              cap.className = 'asset-caption';
              cap.textContent = asset.label;
      
              btn.appendChild(img);
              btn.appendChild(cap);
      
              btn.addEventListener('click', () => {
                if (typeof window.addStickerFromURL === 'function') {
                  window.addStickerFromURL(asset.url);
                } else {
                  alert('addStickerFromURL() is missing ‚Äì check the design engine script.');
                }
              });
      
              grid.appendChild(btn);
            });
        }
      
        // search/filter box
        if (input) {
          input.addEventListener('input', () => renderGrid(input.value));
        }
      
        // first render
        renderGrid();
      });
      </script>
      
  
    
</body>
</html>
